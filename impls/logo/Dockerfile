FROM ubuntu:vivid
MAINTAINER Joel Martin <github@martintribe.org>

##########################################################
# General requirements for testing or common across many
# implementations
##########################################################

RUN apt-get -y update

# Required for running tests
RUN apt-get -y install make python2
RUN ln -s /usr/bin/python2 /usr/local/bin/python

RUN mkdir -p /mal
WORKDIR /mal

##########################################################
# Specific implementation requirements
##########################################################

# Rebuild ucblogo.
# * without X libraries so that the executable starts in text mode.
# * Add the timems function implemented in C

RUN echo 'deb-src http://deb.debian.org/debian stable main' > /etc/apt/sources.list.d/logo.list
RUN apt -y update
RUN apt -y install autoconf autoconf-archive automake dpkg-dev g++ libncurses-dev

RUN cd /tmp \
    && apt source ucblogo \
    && cd /tmp/ucblogo-* \
    && autoreconf -f -i \
    && ./configure --disable-docs --disable-x11 \
    && echo "extern NODE *ltimems(NODE *);" >> globals.h \
    && echo "NODE *ltimems(NODE *args) { struct timeval tv; gettimeofday(&tv, NULL); return(make_floatnode(((FLONUM)tv.tv_sec) * 1000.0 + (tv.tv_usec / 1000))); }" >> coms.c \
    && sed -i -e 's/^\(.*lthrow.*\)$/\1 {"timems", 0, 0, 0, PREFIX_PRIORITY, ltimems},/' init.c \
    && make install \
    && cd /tmp \
    && rm -rf /tmp/ucblogo*

ENV HOME /mal
